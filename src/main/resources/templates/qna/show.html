<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">


<head th:replace="header.html::head"></head>

<body>
<div th:replace="navigation_bar.html::navbar"></div>
<div th:replace="navigation_bar.html::subnav"></div>

<div class="container" id="main" th:name="${article.articleId}">
    <div class="col-md-12 col-sm-12 col-lg-12">
        <div class="panel panel-default">
            <header class="qna-header">
                <h2 class="qna-title" th:text="${article.title}">게시글 제목</h2>
            </header>
            <div class="content-main">
                <article class="article">
                    <div class="article-header">
                        <div class="article-header-thumb">
                            <img src="https://graph.facebook.com/v2.3/100000059371774/picture"
                                 class="article-author-thumb" alt="">
                        </div>
                        <div class="article-header-text">
                            <a th:href="@{/user/profile/{userId}(userId=${article.writer})}" class="article-author-name"
                               th:text="${article.writer}">작성자 아이디</a>
                            <a href="/questions/413" class="article-header-time" title="퍼머링크">
                                2222-22-22 22:22
                                <i class="icon-link"></i>
                            </a>
                        </div>
                    </div>
                    <div class="article-doc">
                        <p th:text="${article.contents}">게시글 내용</p>
                    </div>
                    <div class="article-util">
                        <ul class="article-util-list">
                            <li>
                                <a id="link-modify-article" class="link-modify-article"
                                   th:href="@{/qna/updateForm/{articleId}(articleId=${article.articleId})}">수정</a>
                            </li>
                            <li>
                                <form class="form-delete"
                                      th:action="@{/qna/delete/{articleId}(articleId=${article.getArticleId()})}"
                                      method="POST">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button class="link-delete-article" type="submit">삭제</button>
                                </form>
                            </li>
                            <li>
                                <a class="link-modify-article" href="/index.html">목록</a>
                            </li>
                        </ul>
                    </div>
                </article>

                <div class="qna-comment">
                    <div class="qna-comment-slipp">
                        <p class="qna-comment-count"><strong>2</strong>개의 의견</p>
                        <div class="qna-comment-slipp-articles">

                            <article id="qna-comment-box" class="article"></article>

                            <form id="question" name="question" class="submit-write">
                                <div class="form-group" style="padding:14px;">
                                    <textarea name="content" class="form-control"
                                              placeholder="Update your status"></textarea>
                                </div>
                                <button class="btn btn-success pull-right" type="submit">답변하기</button>
                                <div class="clearfix"/>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


</body>

<footer>
    <div th:replace="footer.html::js"></div>
</footer>
<script src="/js/restAPI.js"></script>

<script>

    const deleteFunction = function () {
        const deleteForms = document.querySelectorAll(".delete-answer-form")
        deleteForms.forEach(deleteForm => {
            deleteForm.addEventListener("submit", evt => {
                evt.preventDefault();
                const replyId = deleteForm.getAttribute("name");
                const formData = new FormData();
                formData.append("replyId", replyId);
                fetch("/reply/delete", {
                    method: "DELETE",
                    headers:{
                        'Content-Type' : 'application/json'
                    },
                    body:JSON.stringify(Object.fromEntries(formData))
                })
                    .then(() =>initReply());
            });
        });
    }

    const articleId = document.getElementById("main").getAttribute("name");
    const initReply = function () {
        fetch(`/reply/${articleId}`)
            .then(response => response.json())
            .then(replies => {
                let contexts = '';
                for (let i = 0; i < replies.length; i++) {
                    contexts += makeReply(replies[i]);
                }
                document.querySelector("#qna-comment-box").innerHTML = contexts;
            })
            .then(() => {
                deleteFunction()
            } )
    }
    initReply();

    const replyForm = document.getElementById("question");
    replyForm.addEventListener('submit', evt => {
        test(evt)
    })
    const test = function (ev) {
        ev.preventDefault();
        requestReply(articleId)
        replyForm.querySelector("textarea").value = "";
    }
</script>

</html>